<script>
    function socket_start() {
        // 避免重复连接
        if (typeof window.globalSocket121 !== 'undefined' && window.globalSocket121.readyState !== WebSocket.CLOSED) {
            return;
        }
        window.globalSocket121 = new WebSocket("ws://127.0.0.1:{{websocketPort}}"),
            window.globalSocket121.onopen = function (t) {
                window.globalSocket121.send("{{websocketToken}}");
            },
            window.globalSocket121.onmessage = function (t) {
                // 解析接收到的数据
                const data = JSON.parse(t.data); // 假设这里接收的是 JSON 格式的数据
                // 从 data 中提取 uuid
                const uuid = data.uuid; // 从数据中提取 UUID
                var method = data.method;
                var url = data.url;
                var body = atob(data.body);
                var headers = JSON.parse(atob(data.headers)) || {};
                // alert(headers);
                // 将 headers 设置为请求头
                const fetchOptions = {
                    method: method,
                    headers: new Headers(headers),
                };

                if (body !== "") {
                    fetchOptions.body = body;
                }

                fetch(url, fetchOptions)
                    .then(response => {
                        const statusCode = response.status;

                        // 将 Headers 对象转换为字典格式
                        const responseHeaders = {};
                        response.headers.forEach((value, key) => {
                            responseHeaders[key] = value; // 将 headers 转换为键值对的形式存储在对象中
                        });

                        return response.text().then(body => ({
                            statusCode: statusCode,
                            headers: responseHeaders, // 使用字典格式的 headers
                            body: body,
                        }));
                    })
                    .then(({ statusCode, headers, body }) => {
                        const textEncoder = new TextEncoder();
                        const bodyAsBytes = textEncoder.encode(body);
                        const bodyAsBase64 = btoa(String.fromCharCode(...bodyAsBytes));


                        // 发送响应回去，包括 uuid
                        const responseMessage = JSON.stringify({
                            uuid: uuid, // 传递回去的 UUID
                            statusCode: statusCode,
                            headers: btoa(JSON.stringify(headers)), // 保持 headers 为字典格式
                            body:bodyAsBase64,
                        });
                        console.log(btoa(JSON.stringify(headers)))
                        window.globalSocket121.send(responseMessage);
                    })
                    .catch((e) => {
                        // 处理错误，发送失败信息
                        const errorMessage = JSON.stringify({
                            uuid: uuid,
                            statusCode: 500,
                            headers: "",
                            body: e.toString(),
                        });
                        window.globalSocket121.send(errorMessage);
                    });
            };
    }

    // 确保只有在 WebSocket 没有连接的情况下启动
    if (typeof window.globalSocket121 === 'undefined' || window.globalSocket121.readyState === WebSocket.CLOSED) {
        socket_start();
    }
    // void 0 !== window.globalSocket121 && window.globalSocket121.readyState !== WebSocket.CLOSED || socket_start();

</script>